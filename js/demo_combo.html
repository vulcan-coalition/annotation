<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Vulcan category demo</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body style="margin: 0px; padding: 0px;">
    <div id="annotation">
    </div>
    <div>
        <input type="button" id="compile-button" value="Compile" />
        <input type="button" id="validate-button" value="Validate" />
        <input type="button" id="decompile-button" value="Decompile" />
    </div>
    <div id="compile-error"></div>
    <textarea id="compile-result" rows="50" cols="50">
    </textarea>
    <script src="./src/vulcan_annotation.js" crossorigin></script>
    <script>
    util = function() {
        const build_div_dom = function(text) {
            const root = document.createElement("div");
            const content = document.createTextNode(text);
            root.appendChild(content);
            return root;
        }
        return {
            build_div_dom: build_div_dom
        };

    }();

    category = function() {

        let info_box;

        const build_ui_node = function(logic_node) {
            const root = document.createElement("div");
            root.appendChild(util.build_div_dom(logic_node.description || logic_node.key || "expand me"));
            if (logic_node.is_selected) root.classList.add("selecting");
            else root.classList.add("deselecting");

            logic_node.set_on_select(function(selected) {
                if (selected) {
                    root.classList.add("selecting");
                    root.classList.remove("deselecting");
                } else {
                    root.classList.add("deselecting");
                    root.classList.remove("selecting");
                }
            });

            // create children
            if (logic_node.inputType != null) {
                // intermediate node (mutual, multiple, property, text)
                if (logic_node.inputType === "text") {
                    const text = document.createElement("input");
                    text.type = 'text';
                    text.value = logic_node.data;
                    root.appendChild(text);
                    root.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                    text.addEventListener('change', function(e) {
                        e.stopPropagation();
                        logic_node.set_data(text.value);
                        logic_node.select(true);
                    });
                    logic_node.set_on_data(function(data) {
                        text.value = data;
                    });
                } else if (logic_node.inputType === "mutual") {
                    // mutual only propagate node when it has been selected.
                    const holder = document.createElement("div");
                    const select = document.createElement("select");
                    for (const child of logic_node.children) {
                        const opt = document.createElement("option");
                        opt.value = child.key;
                        opt.text = child.description;
                        select.appendChild(opt);
                        if (child.is_selected) {
                            opt.selected = true;
                            holder.appendChild(build_ui_node(child));
                        }
                    }
                    root.appendChild(select);
                    select.addEventListener('click', function(e) {
                        e.stopPropagation();
                        while (holder.firstChild) {
                            holder.removeChild(holder.firstChild);
                        }
                        for (const child of logic_node.children) {
                            if (child.key === e.target.value) {
                                holder.appendChild(build_ui_node(child));
                                child.select();
                                break;
                            }
                        }
                    });

                    root.appendChild(holder);

                } else {
                    // property and multiple must show everything
                    const ul = document.createElement("ul");
                    ul.classList.add("hide");
                    for (const child of logic_node.children) {
                        const li = document.createElement("li");
                        li.appendChild(build_ui_node(child));
                        ul.appendChild(li);
                    }
                    root.appendChild(ul);
                    root.addEventListener('click', function(e) {
                        e.stopPropagation();
                        ul.classList.toggle("hide");
                        ul.classList.toggle("show");
                    });
                }

            } else {
                // leaf node
                root.addEventListener('click', function(e) {
                    e.stopPropagation();
                    logic_node.select();
                });
            }

            return root;
        };

        const initialize = function() {

            const root_logic = new Choice({
                "inputType": "mutual",
                "choices": [{
                        "key": "car",
                        "inputType": "mutual",
                        "description": "รถ",
                        "metadata": {
                            "a": 1,
                            "b": {
                                "c": 2
                            }
                        },
                        "choices": [{
                                "key": "type",
                                "inputType": "mutual",
                                "description": "ประเภท",
                                "choices": [{
                                        "key": "car",
                                        "description": "รถเก๋ง"
                                    },
                                    {
                                        "key": "van",
                                        "description": "รถตู้"
                                    },
                                    {
                                        "key": "taxi",
                                        "description": "แท็กซี่"
                                    },
                                    {
                                        "key": "pickup",
                                        "description": "รถกระบะ"
                                    },
                                    {
                                        "key": "truck",
                                        "description": "รถบรรทุก"
                                    },
                                    {
                                        "key": "tuktuk",
                                        "description": "รถตุ๊กตุ๊ก"
                                    },
                                    {
                                        "key": "motorcycle",
                                        "description": "รถมอไซด์"
                                    },
                                    {
                                        "key": "bus",
                                        "description": "รถประจำทาง"
                                    }
                                ]
                            },
                            {
                                "key": "lp_text",
                                "inputType": "text",
                                "description": "เลขทะเบียน"
                            }
                        ]
                    },
                    {
                        "key": "lp",
                        "inputType": "property",
                        "description": "ป้ายทะเบียน",
                        "choices": [{
                                "key": "lp_color",
                                "description": "มีสี"
                            },
                            {
                                "key": "lp_type",
                                "inputType": "mutual",
                                "description": "ประเภทป้าย",
                                "choices": [{
                                        "key": "lpr",
                                        "description": "ป้ายทะเบียนรถยนต์"
                                    },
                                    {
                                        "key": "mlpr",
                                        "description": "ป้ายทะเบียนรถมอไซด์"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }, null);

            document.querySelector('#annotation').appendChild(build_ui_node(root_logic));

            return new Promise(function(resolve, reject) {
                resolve(root_logic);
            });
        };

        return {
            initialize: initialize


        };
    }();

    window.onload = function() {
        category.initialize().then(function(category_node) {

            const compile_button = document.querySelector('#compile-button');
            const validate_button = document.querySelector('#validate-button');
            const decompile_button = document.querySelector('#decompile-button');
            const compile_result = document.querySelector('#compile-result');

            compile_button.addEventListener('click', function(e) {
                const compiled_object = category_node.compile();
                compile_result.value = JSON.stringify(compiled_object);
                const errors = category_node.get_compile_errors(compiled_object);
                for (const err of errors) {
                    err.node = err.node.description || err.node.key;
                    err.error = Choice.interpret_error(err.error);
                }
                document.querySelector('#compile-error').innerHTML = JSON.stringify(errors);
            });

            validate_button.addEventListener('click', function(e) {
                if (category_node.validate(JSON.parse(compile_result.value))) {
                    alert("Valid!");
                } else {
                    alert("Invalid!");
                }
            });

            decompile_button.addEventListener('click', function(e) {
                category_node.select(false);
                category_node.decompile(JSON.parse(compile_result.value));
            });

        });
    };
    </script>
</body>

</html>